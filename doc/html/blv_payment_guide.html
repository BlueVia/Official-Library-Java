<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Bluevia: Payment API guide</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript">
$(document).ready(initResizable);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.3 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Bluevia&#160;<span id="projectnumber">1.5</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Packages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('blv_payment_guide.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<h1>Payment API guide </h1>  </div>
</div>
<div class="contents">
<div class="textblock"><h2><a class="anchor" id="payment_abstract_sec"></a>
Abstract</h2>
<p>The Bluevia Payment API is a set of functions that enables individual, atomic payments based on input economic information. This guide represents a practical introduction to developing applications in which the user wants to provide the Bluevia Payment functionality.</p>
<h2><a class="anchor" id="payment_oauth_protocol_sec"></a>
Payment OAuth protocol</h2>
<p>Bluevia Payment API uses an extension of OAuth protocol to guarantee secure payment operations. For each payment the user makes he must complete the OAuth process to identify itself and get a valid acess token. These tokens will be valid for 48 hours and then will be dismissed. You will find more information in <a class="el" href="blv_oauth_guide.html">Oauth reference</a> OAuth reference.</p>
<p>The extension includes some changes in the OAuth process that are explained above:</p>
<h3><a class="anchor" id="payment_oauth_process_sec"></a>
Payment OAuth process</h3>
<h4><a class="anchor" id="retrieving_payment_request_token_sec"></a>
Step 1: retrieving a request token</h4>
<p>First, you have to retrieve a request token to be authorised by the user. In this case you have to use the PaymentRequestToken object, which includes the Payment info besides the usual request tokens params:</p>
<div class="fragment"><pre class="fragment"><span class="comment">/*</span>
<span class="comment"> Define your callback URL</span>
<span class="comment"> */</span>
OAuthToken consumer = <span class="keyword">new</span> OAuthToken(<span class="stringliteral">&quot;consumer_key&quot;</span>, <span class="stringliteral">&quot;consumer_secret&quot;</span>);
String callBackUrl = <span class="stringliteral">&quot;https://www.example.com&quot;</span>;

<span class="comment">/*</span>
<span class="comment"> Define Payment parameters</span>
<span class="comment"> */</span>
<span class="keywordtype">int</span> amount = 177;
String currency = <span class="stringliteral">&quot;EUR&quot;</span>;

<span class="comment">// NOTE: fake values, user must fill correct data</span>
ServiceInfo serviceInfo = <span class="keyword">new</span> ServiceInfo(<span class="stringliteral">&quot;service_id&quot;</span>, <span class="stringliteral">&quot;bluevia&quot;</span>);

PaymentRequestToken rt = <span class="keyword">new</span> PaymentRequestToken(consumer, mode);
OAuthToken requestToken = rt.getPaymentRequestToken(null, amount, currency, serviceInfo);
</pre></div><p>Note that the callBackUrl is an optional value, you can set it to null if your application is not able to recieve request from BlueVia. Typically websites set a callBackURL and desktop or mobile applications don't. For a more detailed description please see the API Reference.</p>
<h4><a class="anchor" id="retrieving_payment_verification_sec"></a>
Step 2: Take the user to BlueVia Connect</h4>
<p>Take the user to BlueVia Connect to authorise the application as usual.</p>
<h4><a class="anchor" id="retrieving_payment_access_token_sec"></a>
Step 3: retrieveing an access token</h4>
<p>With the obatined oauth_verifier, you can now get the accessToken as follows:</p>
<div class="fragment"><pre class="fragment">AccessToken at = <span class="keyword">new</span> AccessToken(consumer, requestToken);
OAuthToken accessToken = at.get(oauth_verifier);
</pre></div><h2><a class="anchor" id="make_payment_sec"></a>
Make a Payment</h2>
<p>Once the user has requested the access token it is possible to make the payment. The Payment info included in this request must agree with the info supplied when the token was requested.</p>
<div class="fragment"><pre class="fragment">PaymentOperation op = <span class="keyword">new</span> PaymentOperation(consumer, accesstoken, mode);

<span class="keywordtype">int</span> amount = 177;
String currency = <span class="stringliteral">&quot;EUR&quot;</span>;

PaymentResultType result = op.payment(amount, currency);

System.out.println(<span class="stringliteral">&quot;Transaction id: &quot;</span> + result.getTransactionId());
System.out.println(<span class="stringliteral">&quot;Transaction status: &quot;</span> + result.getTransactionStatus());
System.out.println(<span class="stringliteral">&quot;Description: &quot;</span> + result.getTransactionStatusDescription());
</pre></div><h2><a class="anchor" id="make_payment_receipt_req_sec"></a>
Make a Payment with status notification</h2>
<p>It is possible to receive status notifications by providing BlueVia with an URI where notifications must be sent. This URI is provided during the Payment operation, including the endpoint and correlator parameters:</p>
<div class="fragment"><pre class="fragment">String endpoint = <span class="stringliteral">&quot;https://www.example.com&quot;</span>;
String correlator = <span class="stringliteral">&quot;1234&quot;</span>;
op.payment(amount, currency, endpoint, correlator);
</pre></div><h2><a class="anchor" id="payment_status_sec"></a>
Get payment status</h2>
<p>The function getPaymentStatus allows to request the status of a previous payment operation:</p>
<div class="fragment"><pre class="fragment">PaymentResultType result = op.payment(endpoint, correlator);

GetPaymentStatusResultType status = op.getStatus(result.getTransactionId());

System.out.println(<span class="stringliteral">&quot;Transaction status: &quot;</span> + status.getTransactionStatus());
System.out.println(<span class="stringliteral">&quot;Description: &quot;</span> + status.getTransactionStatusDescription());
</pre></div><h2><a class="anchor" id="cancel_authorization_sec"></a>
Cancel authorization</h2>
<p>After having requested a token you can cancel the authorization for that token before making the payment:</p>
<div class="fragment"><pre class="fragment">PaymentOperation op = <span class="keyword">new</span> PaymentOperation(consumer, accesstoken, mode);
op.cancelAuthorization();
</pre></div><h2><a class="anchor" id="payment_code_example_sec"></a>
Bluevia Payment API: Code example</h2>
<div class="fragment"><pre class="fragment">System.out.println(<span class="stringliteral">&quot;***** PaymentExample getRequestToken&quot;</span>);

<span class="keywordflow">try</span> {
        PaymentRequestToken rt = <span class="keyword">new</span> PaymentRequestToken(consumer, mode);

        <span class="keywordtype">int</span> amount = 177;
        String currency = <span class="stringliteral">&quot;EUR&quot;</span>;

        <span class="comment">// NOTE: fake values, user must fill correct data</span>
        ServiceInfo serviceInfo = <span class="keyword">new</span> ServiceInfo(<span class="stringliteral">&quot;service_id&quot;</span>, <span class="stringliteral">&quot;bluevia&quot;</span>);
                        
        OAuthToken requestToken = rt.getPaymentRequestToken(null, amount, currency, serviceInfo);

        System.out.println(<span class="stringliteral">&quot;Token: &quot;</span> + requestToken.getToken());
        System.out.println(<span class="stringliteral">&quot;Secret: &quot;</span> + requestToken.getSecret());
        System.out.println(<span class="stringliteral">&quot;Url: &quot;</span> + requestToken.getUrl());

        System.out.println(<span class="stringliteral">&quot;oauth_verifier: &quot;</span>);
        Scanner in = <span class="keyword">new</span> Scanner(System.in);     
        String oauth_verifier = in.nextLine();

        System.out.println(<span class="stringliteral">&quot;***** PaymentExample getAccessToken&quot;</span>);
        AccessToken at = <span class="keyword">new</span> AccessToken();

        accesstoken = at.get(consumer, requestToken, oauth_verifier);
        System.out.println(<span class="stringliteral">&quot;Access Token:&quot;</span> + accesstoken.getToken());
        System.out.println(<span class="stringliteral">&quot;Access Token Secret:&quot;</span> + accesstoken.getSecret());

        System.out.println(<span class="stringliteral">&quot;***** PaymentExample payment operation&quot;</span>);

        PaymentOperation op = <span class="keyword">new</span> PaymentOperation(consumer, accesstoken, mode);
        PaymentResultType result = op.payment(amount, currency);

        System.out.println(<span class="stringliteral">&quot;Transaction id: &quot;</span> + result.getTransactionId());
        System.out.println(<span class="stringliteral">&quot;Transaction status: &quot;</span> + result.getTransactionStatus());
        System.out.println(<span class="stringliteral">&quot;Description: &quot;</span> + result.getTransactionStatusDescription());

        System.out.println(<span class="stringliteral">&quot;***** PaymentExample get payment status&quot;</span>);

        GetPaymentStatusResultType status = op.getStatus(result.getTransactionId());

        System.out.println(<span class="stringliteral">&quot;Transaction status: &quot;</span> + result.getTransactionStatus());
        System.out.println(<span class="stringliteral">&quot;Description: &quot;</span> + status.getTransactionStatusDescription());

} <span class="keywordflow">catch</span> (JAXBException ex) {
        Logger.getLogger(PaymentExample.class.getName()).log(Level.SEVERE, null, ex);
} 
</pre></div> </div></div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="footer">Generated on Thu Jan 26 2012 12:33:27 for Bluevia by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.3 </li>
    </ul>
  </div>

</body>
</html>
